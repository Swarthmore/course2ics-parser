const{RRule:e}=require("rrule"),t=require("fs").promises,r=require("papaparse"),a=require("ics"),i=require("moment"),{validateArgs:n,validateRow:s}=require("./validators"),{daysFromString:o,timeDiff:c,firstDayAfterDate:l,flipName:u}=require("./helpers"),m=require("path"),f=require("pug");i().format(),i.suppressDeprecationWarnings=!0,module.exports={parse:async function(f){const p=e=>{f.verbose&&console.debug("string"==typeof e?e:JSON.stringify(e))};async function y({title:t,subject:r,course:n,section:s,instructor:m,email:f,days:p,times:y,fromDate:w,toDate:d}){const D=o(p),g=new e({freq:e.WEEKLY,byweekday:D.map(t=>{switch(t){case"U":return e.SU;case"M":return e.MO;case"T":return e.TU;case"W":return e.WE;case"R":return e.TH;case"F":return e.FR;case"S":return e.SA}}).filter(e=>e),until:new Date(d)}),b=l(w,p,y,i).format("YYYY-M-D-H-m").split("-"),h=c(y),[,j]=g.toString().split("RRULE:"),S={start:b,duration:h,recurrenceRule:j,title:`${r} ${n} ${s}`,description:t,status:"CONFIRMED",organizer:{name:u(m),email:f}};return new Promise((e,t)=>{a.createEvent(S,(r,a)=>{r&&t(r),e(a)})})}async function w(e,r){try{return await t.writeFile(r,e),r}catch(e){return e}}const d=await n(f),D=m.normalize(d.outputDir),g=await async function(e){try{return await t.readFile(e,"utf8")}catch(e){return e}}(m.normalize(d.inputFile));return async function(){return new Promise((e,a)=>{r.parse(g,{complete:async r=>{let i=[];const n=r.data.slice(1);0===n.length&&a("No rows could be parsed from csv");let o=0;var c,l=!0,u=!1;try{for(var f,g,b=function(e){var t;if("undefined"!=typeof Symbol){if(Symbol.asyncIterator&&null!=(t=e[Symbol.asyncIterator]))return t.call(e);if(Symbol.iterator&&null!=(t=e[Symbol.iterator]))return t.call(e)}throw new TypeError("Object is not async iterable")}(n);l=(f=await b.next()).done,g=await f.value,!l;l=!0){let e=g;try{p("-------------------------------------------"),p("Processing row "+o),p(e);const t=await s(e),[r,a,n,c,l,u,f,g,b,h,j,S]=t,F=await y({title:r,subject:a,course:n,section:S,instructor:c,email:u,days:g,times:h,fromDate:d.fromDate,toDate:d.toDate}),$=`${r.replace(/[/\\?%*:|"<>\s]/g,"-")}__${S}_${g.replace(/,/g,"")}__${h.replace(/[:-\s]/g,"")}`,q=".ics",v=m.join(D,$+q),_=await w(F,v);if(p("Created "+_),i.push({title:r,subject:a,course:n,section:S,instructor:c,email:u,days:g,times:h,fromDate:d.fromDate,toDate:d.toDate,filename:m.basename(_)}),b&&j){const e=await y({title:r,subject:a,course:n,section:S,instructor:c,email:u,days:b,times:j,fromDate:d.fromDate,toDate:d.toDate}),t=`${r.replace(/[/\\?%*:|"<>\s]/g,"-")}__${S}_${b.replace(/,/g,"")}__${j.replace(/[:-\s]/g,"")}`,s=m.join(D,t+q),o=await w(e,s);p("Created "+o),i.push({title:r,subject:a,course:n,section:S,instructor:c,email:u,days:b,times:j,fromDate:d.fromDate,toDate:d.toDate,filename:m.basename(o)})}}catch(e){p(e)}finally{o++}}}catch(e){u=!0,c=e}finally{try{l||null==b.return||await b.return()}finally{if(u)throw c}}await t.writeFile(D+"/index.json",JSON.stringify(i),"utf8"),p("Done!"),e(i)}})})}()},makeSite:async function(e){const r=await t.readdir(e),[a]=r.filter(e=>".json"===m.extname(e));if(!a)throw new Error("No index file found");const i=await t.readFile(m.join(e,a)),n=f.compileFile(m.join(process.cwd(),"src","templates","report.pug"))({results:i});await t.writeFile(m.join(e,"index.html"),n,"utf8")}};
//# sourceMappingURL=course2ics-parser.js.map
